# Session Notes: Phase 4 Planning - Content Management & Organization

**Date**: 2025-12-05
**Session ID**: 0057
**Focus**: Planning Phase 4 implementation strategy

---

## Session Summary

Analyzed Phase 4 requirements from the acceleration roadmap and created a detailed implementation plan for the Content Management & Organization features.

---

## Phase 4 Features

### 1. Journal System (Priority 1)
- Journal entry CRUD with multi-page support
- Rich text editor (markdown/WYSIWYG)
- Image/PDF embedding
- Folder organization
- **New Tables**: `journals`, `journal_pages`, `folders`

### 2. Measurement Tools (Priority 2)
- Ruler for distance measurement
- AoE templates (cone, circle, ray, rectangle)
- Grid snapping
- Unit configuration (ft, m, etc.)
- **New Tables**: `measurement_templates` (optional persistence)

### 3. Drawing Tools (Priority 3)
- Freehand drawing
- Shape tools (rectangle, circle, polygon)
- Text annotations
- Color/stroke settings
- Layer management
- **New Tables**: `drawings`, `drawing_layers`

### 4. Advanced Scene Features (Priority 4)
- Tile system (background/foreground overlays)
- Region system (trigger zones)
- Scene pins/notes (linked to journals)
- Multiple map layers
- **New Tables**: `tiles`, `regions`, `scene_pins`, `scene_layers`

### 5. Compendium System (Priority 5)
- Content packs (monsters, spells, items)
- Import/export functionality
- Full-text search
- Drag-drop to scene/actor
- **New Tables**: `compendiums`, `compendium_entries`

---

## Recommended Implementation Order

| Phase | Feature | Duration | Rationale |
|-------|---------|----------|-----------|
| 4A | Journal System | 1-2 weeks | Foundation for rich text, folder patterns |
| 4B | Measurement Tools | 1 week | Extends existing canvas, low complexity |
| 4C | Drawing Tools | 1-2 weeks | Builds on canvas patterns |
| 4D | Advanced Scene Features | 1-2 weeks | Depends on Journal for pins |
| 4E | Compendium System | 2-3 weeks | Complex, depends on journal patterns |

**Total Estimated Duration**: 6-10 weeks

---

## Database Schema Overview

### journals
```sql
- id, gameId, name, img, folderId, permission, ownerId, sort, data
```

### journal_pages
```sql
- id, journalId, name, pageType (text/image/pdf/video), content, src, sort
```

### folders
```sql
- id, gameId, name, folderType, parentId, color, sort
```

### drawings
```sql
- id, sceneId, authorId, drawingType, x, y, z, rotation, points (jsonb)
- strokeColor, strokeWidth, fillColor, fillAlpha, text, fontSize
```

### tiles
```sql
- id, sceneId, img, x, y, z, width, height, rotation, tint, alpha
- hidden, locked, overhead, roof, occlusion (jsonb)
```

### regions
```sql
- id, sceneId, name, shape, x, y, width, height, points (jsonb)
- triggerType, triggerAction, triggerData (jsonb), environmentEffects
```

### scene_pins
```sql
- id, sceneId, x, y, icon, text, journalId, pageId, global
```

### compendiums
```sql
- id, gameId, name, label, entityType, system, locked, private
```

### compendium_entries
```sql
- id, compendiumId, name, img, entityType, entityData (jsonb)
- searchIndex, tags[], sort
```

---

## API Endpoints Summary

### Journal System (14 endpoints)
- `/api/v1/games/:gameId/journals` - CRUD
- `/api/v1/journals/:journalId/pages` - Page management
- `/api/v1/games/:gameId/folders` - Folder management

### Measurement Tools (6 endpoints)
- `/api/v1/scenes/:sceneId/templates` - Template CRUD

### Drawing Tools (8 endpoints)
- `/api/v1/scenes/:sceneId/drawings` - Drawing CRUD
- `/api/v1/scenes/:sceneId/drawing-layers` - Layer management

### Advanced Scene Features (16 endpoints)
- `/api/v1/scenes/:sceneId/tiles` - Tile CRUD
- `/api/v1/scenes/:sceneId/regions` - Region CRUD
- `/api/v1/scenes/:sceneId/pins` - Pin CRUD
- `/api/v1/scenes/:sceneId/layers` - Layer CRUD

### Compendium System (13 endpoints)
- `/api/v1/compendiums` - Compendium CRUD
- `/api/v1/compendiums/:id/entries` - Entry management
- `/api/v1/compendiums/:id/import` - Import
- `/api/v1/compendiums/:id/export` - Export

---

## WebSocket Events Summary

### Journal Events
- `journal:create/created`, `journal:update/updated`, `journal:delete/deleted`
- `journal:show/shown` - GM shows journal to players
- `page:update/updated` - Live page editing

### Measurement Events
- `measure:start/update/end/clear` - Live measurement preview
- `template:place/placed`, `template:remove/removed`

### Drawing Events
- `drawing:create/created`, `drawing:update/updated`, `drawing:delete/deleted`
- `drawing:stream/streamed` - Live freehand drawing

### Advanced Scene Events
- `tile:add/added`, `tile:update/updated`, `tile:remove/removed`
- `region:enter`, `region:exit` - Token triggers
- `pin:click`, `pin:opened` - Pin interaction

### Compendium Events
- `compendium:entry-added/updated/removed`
- `compendium:instantiate/instantiated` - Create entity from entry

---

## Frontend Components Summary

### Shared/Reusable Components
- `RichTextEditor.svelte` - Markdown/WYSIWYG editor
- `FolderTree.svelte` - Hierarchical folder display
- `ColorPicker.svelte` - Color selection
- `DragDropHandler.svelte` - Drag-drop functionality
- `SearchInput.svelte` - Search with filters
- `ContextMenu.svelte` - Right-click menus

### Journal Components
- `JournalDirectory.svelte`, `JournalSheet.svelte`
- `JournalPageList.svelte`, `JournalPage.svelte`

### Canvas Tools Components
- `MeasurementLayer.svelte`, `RulerTool.svelte`, `TemplateTool.svelte`
- `DrawingLayer.svelte`, `FreehandTool.svelte`, `ShapeTool.svelte`
- `TileLayer.svelte`, `RegionLayer.svelte`, `ScenePinLayer.svelte`

### Compendium Components
- `CompendiumBrowser.svelte`, `CompendiumList.svelte`
- `CompendiumEntryList.svelte`, `CompendiumEntryCard.svelte`
- `CompendiumImport.svelte`, `CompendiumExport.svelte`

---

## Critical Files for Implementation

1. **`packages/database/src/schema/index.ts`** - Add new schema exports
2. **`apps/server/src/routes/api/v1/index.ts`** - Register new routes
3. **`apps/server/src/websocket/handlers/game.ts`** - Add WebSocket handlers
4. **`packages/shared/src/types/websocket.ts`** - Extend WebSocket types
5. **`apps/web/src/lib/components/SceneCanvas.svelte`** - Add canvas layers

---

## Risk Factors

1. **Rich Text Editor**: May need third-party library (TipTap, Quill, ProseMirror)
2. **Canvas Performance**: Drawing layer with many points needs optimization
3. **Compendium Search**: Large datasets need PostgreSQL full-text search tuning
4. **Drag-Drop**: Cross-component drag-drop complexity in SvelteKit
5. **Region Triggers**: Real-time collision detection requires careful implementation

---

## Next Steps

1. **Start Phase 4A: Journal System**
   - Create database schema (`journals`, `journal_pages`, `folders`)
   - Run migrations
   - Implement REST API routes
   - Implement WebSocket handlers
   - Build frontend components
   - Deploy to Docker

---

## Current Status

**Phase 4A - Journal System - IN PROGRESS**

### Completed Tasks
1. Database schema created (`journals`, `journal_pages`, `folders`) - See `packages/database/src/schema/journals.ts`
2. TypeScript types defined - See `packages/shared/src/types/journal.ts`
3. **REST API routes implemented** - See `apps/server/src/routes/api/v1/journals.ts`
   - 4 Folder endpoints: list, create, update, delete
   - 5 Journal endpoints: list, get with pages, create, update, delete
   - 5 Journal Page endpoints: list, create, update, delete, reorder
   - All routes use authentication middleware
   - Proper error handling and validation
   - Support for query params (folderType, folderId)
4. Routes registered in API index
5. TypeScript compilation verified
6. Deployed to Docker and verified running
7. API endpoints confirmed accessible via HTTPS

### Verified API Endpoints
- `GET /api/v1/games/:gameId/folders` - List folders (with optional folderType filter)
- `POST /api/v1/games/:gameId/folders` - Create folder
- `PATCH /api/v1/folders/:folderId` - Update folder
- `DELETE /api/v1/folders/:folderId` - Delete folder
- `GET /api/v1/games/:gameId/journals` - List journals (with optional folderId filter)
- `GET /api/v1/journals/:journalId` - Get journal with pages
- `POST /api/v1/games/:gameId/journals` - Create journal
- `PATCH /api/v1/journals/:journalId` - Update journal
- `DELETE /api/v1/journals/:journalId` - Delete journal
- `GET /api/v1/journals/:journalId/pages` - List pages
- `POST /api/v1/journals/:journalId/pages` - Create page
- `PATCH /api/v1/pages/:pageId` - Update page
- `DELETE /api/v1/pages/:pageId` - Delete page
- `PATCH /api/v1/pages/:pageId/reorder` - Reorder page

### Remaining Tasks for Phase 4A
1. Implement WebSocket handlers for real-time journal updates
2. Build frontend components:
   - `JournalDirectory.svelte` - Journal navigation sidebar
   - `JournalSheet.svelte` - Main journal display
   - `JournalPageList.svelte` - Page navigation
   - `JournalPage.svelte` - Individual page viewer/editor
   - `FolderTree.svelte` - Hierarchical folder display
   - `RichTextEditor.svelte` - Page content editor
3. Add journal routes to web app
4. Test end-to-end functionality
5. Write tests for API routes

---

**Session completed at**: 2025-12-05
