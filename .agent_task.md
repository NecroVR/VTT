# Task: Implement Tree View Navigation for Form Designer

## Objective
Create a hierarchical tree view component that displays the form structure and allows users to navigate and select nodes in the Form Designer.

## Context
- The FormDesigner framework is complete with three-panel layout at `apps/web/src/lib/components/designer/FormDesigner.svelte`
- Designer store exists at `apps/web/src/lib/stores/formDesigner.ts` with all necessary operations
- Types are at `packages/shared/src/types/forms.ts`
- The tree view will be added to the LEFT panel, below the Component Palette (which doesn't exist yet, so it will be the only component in the left panel for now)

## Files to Create

### 1. Tree Helper Utilities: `apps/web/src/lib/components/designer/treeHelpers.ts`

Create utility functions for tree operations:

```typescript
import type { LayoutNode, FormFieldType } from '@vtt/shared';

/**
 * Get display information for a tree node
 */
export function getTreeNodeInfo(node: LayoutNode): { icon: string; label: string } {
  switch (node.type) {
    case 'field':
      return {
        icon: getFieldIcon(node.fieldType),
        label: node.label || node.binding || 'Field'
      };
    case 'container':
      return { icon: 'üì¶', label: 'Container' };
    case 'grid':
      return { icon: '‚äû', label: `Grid (${node.columns} cols)` };
    case 'flex':
      return { icon: '‚ÜîÔ∏è', label: `Flex (${node.direction})` };
    case 'columns':
      return { icon: '‚ñ¶', label: `Columns (${node.widths.length})` };
    case 'tabs':
      return { icon: 'üìë', label: 'Tabs' };
    case 'section':
      return { icon: 'üìÅ', label: node.title || 'Section' };
    case 'group':
      return { icon: '‚ñ¢', label: node.title || 'Group' };
    case 'repeater':
      return { icon: 'üîÅ', label: `Repeater (${node.binding})` };
    case 'conditional':
      return { icon: '‚ùì', label: 'Conditional' };
    case 'static':
      return { icon: 'üìù', label: `Static (${node.contentType || 'text'})` };
    case 'image':
      return { icon: 'üñºÔ∏è', label: 'Image' };
    case 'spacer':
      return { icon: '‚¨ö', label: 'Spacer' };
    case 'divider':
      return { icon: '‚îÄ', label: 'Divider' };
    case 'fragmentRef':
      return { icon: 'üß©', label: `Fragment (${node.fragmentId})` };
    case 'computed':
      return { icon: '‚àë', label: node.label || `Computed (${node.fieldId})` };
    default:
      return { icon: '‚ùî', label: 'Unknown' };
  }
}

/**
 * Get icon for a field type
 */
function getFieldIcon(fieldType: FormFieldType): string {
  const icons: Record<FormFieldType, string> = {
    text: 'üìù',
    number: '#Ô∏è‚É£',
    checkbox: '‚òëÔ∏è',
    select: 'üìã',
    textarea: 'üìÑ',
    dice: 'üé≤',
    resource: '‚ù§Ô∏è',
    rating: '‚≠ê',
    slider: 'üéöÔ∏è',
    tags: 'üè∑Ô∏è',
    reference: 'üîó',
    richtext: 'üìÉ',
    color: 'üé®',
    image: 'üñºÔ∏è',
    date: 'üìÖ'
  };
  return icons[fieldType] || 'üìù';
}

/**
 * Get children nodes from any node type
 */
export function getNodeChildren(node: LayoutNode): LayoutNode[] {
  // Direct children array
  if ('children' in node && Array.isArray(node.children)) {
    return node.children;
  }

  // Tabs node - flatten all tabs' children
  if (node.type === 'tabs' && node.tabs) {
    return node.tabs.flatMap(tab => tab.children || []);
  }

  // Repeater node - item template
  if (node.type === 'repeater' && node.itemTemplate) {
    return node.itemTemplate;
  }

  // Conditional node - both branches
  if (node.type === 'conditional') {
    return [
      ...(node.then || []),
      ...(node.else || [])
    ];
  }

  return [];
}

/**
 * Check if a node has children
 */
export function hasChildren(node: LayoutNode): boolean {
  return getNodeChildren(node).length > 0;
}
```

### 2. Tree Node Component: `apps/web/src/lib/components/designer/TreeNode.svelte`

Create a recursive tree node component:

```svelte
<script lang="ts">
  import type { LayoutNode } from '@vtt/shared';
  import { getTreeNodeInfo, getNodeChildren, hasChildren } from './treeHelpers';

  interface Props {
    node: LayoutNode;
    depth?: number;
    isSelected?: boolean;
    isExpanded?: boolean;
    onSelect?: (nodeId: string) => void;
    onToggleExpand?: (nodeId: string) => void;
    expandedNodes?: Set<string>;
    selectedNodeId?: string | null;
  }

  let {
    node,
    depth = 0,
    isSelected = false,
    isExpanded = false,
    onSelect,
    onToggleExpand,
    expandedNodes,
    selectedNodeId
  }: Props = $props();

  const nodeInfo = $derived(getTreeNodeInfo(node));
  const children = $derived(getNodeChildren(node));
  const _hasChildren = $derived(children.length > 0);
  const _isExpanded = $derived(expandedNodes?.has(node.id) ?? isExpanded);

  function handleClick(event: MouseEvent) {
    event.stopPropagation();
    onSelect?.(node.id);
  }

  function handleToggleExpand(event: MouseEvent) {
    event.stopPropagation();
    if (_hasChildren) {
      onToggleExpand?.(node.id);
    }
  }

  function handleDoubleClick(event: MouseEvent) {
    event.stopPropagation();
    if (_hasChildren) {
      onToggleExpand?.(node.id);
    }
  }
</script>

<div class="tree-node" class:selected={isSelected}>
  <div
    class="tree-node-content"
    style="padding-left: {depth * 16}px"
    onclick={handleClick}
    ondblclick={handleDoubleClick}
    role="button"
    tabindex="0"
  >
    {#if _hasChildren}
      <button
        class="expand-arrow"
        class:expanded={_isExpanded}
        onclick={handleToggleExpand}
        aria-label={_isExpanded ? 'Collapse' : 'Expand'}
      >
        ‚ñ∂
      </button>
    {:else}
      <span class="expand-spacer"></span>
    {/if}

    <span class="node-icon">{nodeInfo.icon}</span>
    <span class="node-label">{nodeInfo.label}</span>
  </div>

  {#if _hasChildren && _isExpanded}
    <div class="tree-node-children">
      {#each children as child (child.id)}
        <svelte:self
          node={child}
          depth={depth + 1}
          isSelected={child.id === selectedNodeId}
          {expandedNodes}
          {selectedNodeId}
          {onSelect}
          {onToggleExpand}
        />
      {/each}
    </div>
  {/if}
</div>

<style>
  .tree-node {
    user-select: none;
  }

  .tree-node-content {
    display: flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    transition: background-color 0.15s;
    gap: 0.25rem;
  }

  .tree-node-content:hover {
    background: var(--hover-bg, #f0f0f0);
  }

  .tree-node.selected > .tree-node-content {
    background: var(--primary-color, #007bff);
    color: white;
  }

  .tree-node.selected > .tree-node-content:hover {
    background: var(--primary-color-hover, #0056b3);
  }

  .expand-arrow {
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-size: 0.625rem;
    line-height: 1;
    width: 12px;
    height: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    color: inherit;
  }

  .expand-arrow.expanded {
    transform: rotate(90deg);
  }

  .expand-spacer {
    width: 12px;
    height: 12px;
    display: inline-block;
  }

  .node-icon {
    font-size: 1rem;
    line-height: 1;
    flex-shrink: 0;
  }

  .node-label {
    font-size: 0.875rem;
    line-height: 1.2;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .tree-node-children {
    /* Children are rendered recursively */
  }
</style>
```

### 3. Tree View Component: `apps/web/src/lib/components/designer/TreeView.svelte`

Create the main tree view component:

```svelte
<script lang="ts">
  import type { LayoutNode } from '@vtt/shared';
  import TreeNode from './TreeNode.svelte';

  interface Props {
    layout: LayoutNode[];
    selectedNodeId?: string | null;
    onSelectNode?: (nodeId: string) => void;
  }

  let { layout, selectedNodeId = null, onSelectNode }: Props = $props();

  // Track expanded nodes
  let expandedNodes = $state(new Set<string>());

  function handleToggleExpand(nodeId: string) {
    if (expandedNodes.has(nodeId)) {
      expandedNodes.delete(nodeId);
    } else {
      expandedNodes.add(nodeId);
    }
    // Force reactivity
    expandedNodes = new Set(expandedNodes);
  }

  function handleSelectNode(nodeId: string) {
    onSelectNode?.(nodeId);
  }

  // Auto-expand parent nodes when a node is selected
  function expandToNode(nodes: LayoutNode[], targetId: string, parentId?: string): boolean {
    for (const node of nodes) {
      if (node.id === targetId) {
        if (parentId) {
          expandedNodes.add(parentId);
        }
        return true;
      }

      // Check children
      let childNodes: LayoutNode[] = [];
      if ('children' in node && Array.isArray(node.children)) {
        childNodes = node.children;
      } else if (node.type === 'tabs' && node.tabs) {
        childNodes = node.tabs.flatMap(tab => tab.children || []);
      } else if (node.type === 'repeater' && node.itemTemplate) {
        childNodes = node.itemTemplate;
      } else if (node.type === 'conditional') {
        childNodes = [...(node.then || []), ...(node.else || [])];
      }

      if (childNodes.length > 0) {
        const found = expandToNode(childNodes, targetId, node.id);
        if (found) {
          if (parentId) {
            expandedNodes.add(parentId);
          }
          expandedNodes.add(node.id);
          return true;
        }
      }
    }
    return false;
  }

  // Watch for selection changes and auto-expand
  $effect(() => {
    if (selectedNodeId) {
      expandToNode(layout, selectedNodeId);
      expandedNodes = new Set(expandedNodes);
    }
  });
</script>

<div class="tree-view">
  <div class="tree-view-header">
    <h4>Structure</h4>
    {#if layout.length === 0}
      <span class="node-count">Empty</span>
    {:else}
      <span class="node-count">{layout.length} root node(s)</span>
    {/if}
  </div>

  <div class="tree-view-content">
    {#if layout.length === 0}
      <div class="empty-message">
        <p>No components yet</p>
        <p class="hint">Drag components from the palette to get started</p>
      </div>
    {:else}
      {#each layout as node (node.id)}
        <TreeNode
          {node}
          depth={0}
          isSelected={node.id === selectedNodeId}
          {expandedNodes}
          {selectedNodeId}
          onSelect={handleSelectNode}
          onToggleExpand={handleToggleExpand}
        />
      {/each}
    {/if}
  </div>
</div>

<style>
  .tree-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .tree-view-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: var(--panel-header-bg, #f8f9fa);
    border-bottom: 1px solid var(--border-color, #ddd);
  }

  .tree-view-header h4 {
    margin: 0;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-muted, #6c757d);
  }

  .node-count {
    font-size: 0.75rem;
    color: var(--text-muted, #6c757d);
  }

  .tree-view-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .empty-message {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-muted, #6c757d);
  }

  .empty-message p {
    margin: 0 0 0.5rem 0;
  }

  .hint {
    font-size: 0.75rem;
    font-style: italic;
  }
</style>
```

### 4. Integration: Update `apps/web/src/lib/components/designer/FormDesigner.svelte`

Add the TreeView to the left panel. Find the left panel section (around line 173-183) and replace it with:

```svelte
      <!-- Left Panel: Component Palette & Tree View -->
      <div class="panel panel-left">
        <div class="panel-header">
          <h3>Components</h3>
        </div>
        <div class="panel-content">
          <div class="placeholder">
            <p>Component Palette</p>
            <p class="placeholder-note">(To be implemented in Phase 3.2)</p>
          </div>
        </div>

        <!-- Tree View Section -->
        <TreeView
          layout={store.form?.layout || []}
          selectedNodeId={store.selectedNodeId}
          onSelectNode={(nodeId) => formDesignerStore.selectNode(nodeId)}
        />
      </div>
```

Add the import at the top of the script section:

```svelte
import TreeView from './TreeView.svelte';
```

Update the styles to accommodate both sections in the left panel:

```css
  .panel-left {
    grid-column: 1;
    display: flex;
    flex-direction: column;
  }

  .panel-left .panel-content {
    flex: 0 0 auto;
    max-height: 40%;
    overflow: auto;
  }
```

## Key Requirements

1. **Icons**: Use emoji icons for visual clarity
2. **Expand/Collapse**: Small triangle arrow that rotates 90deg when expanded
3. **Selection**: Blue background for selected node
4. **Hover**: Light gray background on hover
5. **Indentation**: 16px per depth level
6. **Auto-expand**: When a node is selected, auto-expand all parent nodes to show it
7. **Recursive**: TreeNode component calls itself for children
8. **Performance**: Use keyed each blocks with node.id

## Testing Checklist

After implementation:
1. Verify tree view appears in left panel below placeholder
2. Check that nodes display with correct icons and labels
3. Test expand/collapse functionality
4. Test node selection (should highlight and update store)
5. Verify auto-expand when selecting nested nodes
6. Check scrolling works for long trees
7. Verify hover and selection styling

## Notes

- The Component Palette doesn't exist yet, so TreeView will be the main content in the left panel
- All node types from the types file should have appropriate icons and labels
- The tree should handle deeply nested structures gracefully
- Keep the UI lightweight and performant

## Success Criteria

- [ ] All three files created with correct code
- [ ] TreeView integrated into FormDesigner.svelte
- [ ] Tree displays all node types correctly
- [ ] Selection syncs with designer store
- [ ] Expand/collapse works smoothly
- [ ] Auto-expand to selected node works
- [ ] No TypeScript errors
- [ ] No runtime errors in console
